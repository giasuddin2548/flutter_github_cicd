name: Flutter

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  flutter_job:
    runs-on: macos-latest

    steps:
      # Checkout repository
      - uses: actions/checkout@v4

      # Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # Install project dependencies
      - name: Install dependencies
        run: flutter pub get

      # Format check
      - name: Verify formatting
        run: dart format --output=none --set-exit-if-changed .

      # Static analysis
      - name: Analyze project source
        run: flutter analyze

      # Run tests (basic test needed to avoid 0 test error)
      - name: Run tests
        run: flutter test

      # Build Android APK
      - name: Build Android APK
        run: flutter build apk --release

      # Upload APK to Firebase App Distribution
      - name: Upload APK to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1.7.0
        with:
          appId: ${{ secrets.FIREBASE_APP_ID_ANDROID }}
          serviceCredentialsFileContent: ${{ secrets.SERVICE_CREDENTIALS_FILE_CONTENT }}
          groups: all_testers
          file: build/app/outputs/flutter-apk/app-release.apk

      # Build iOS IPA
      - name: Build iOS IPA
        run: flutter build ipa --release --export-options-plist=ios/ExportOptions.plist

      # Install Firebase CLI
      - name: Install Firebase CLI
        run: curl -sL https://firebase.tools | bash

      # Upload IPA using Firebase CLI (required for macOS runner)
      - name: Upload IPA to Firebase App Distribution
        run: |
          firebase appdistribution:distribute build/ios/ipa/Runner.ipa \
            --app ${{ secrets.FIREBASE_APP_ID_IOS }} \
            --token ${{ secrets.FIREBASE_CLI_TOKEN }} \
            --groups "all_testers"
